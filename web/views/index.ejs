<%- include('layouts/main', { title: 'Dashboard', body: `
<div class="p-6 lg:p-8">
    <!-- Header with Search -->
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
        <div>
            <h1 class="text-3xl font-bold text-white">Welcome back</h1>
            <p class="text-gray-400 mt-1">Here's what's happening with your media library</p>
        </div>
        <div class="relative">
            <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
            <input type="text" id="quick-search" placeholder="Search movies, series..."
                   class="input input-search w-full md:w-80" />
        </div>
    </div>

    <!-- Stats Grid -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 lg:gap-6 mb-8">
        <div class="stat-card group">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm font-medium">Movies</p>
                    <p class="text-3xl font-bold text-white mt-2" id="stat-movies">-</p>
                </div>
                <div class="stat-card-icon bg-primary-500/10 group-hover:bg-primary-500/20 transition-colors">
                    <svg class="w-6 h-6 text-primary-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.375 19.5h17.25m-17.25 0a1.125 1.125 0 01-1.125-1.125M3.375 19.5h1.5C5.496 19.5 6 18.996 6 18.375m-3.75 0V5.625m0 12.75v-1.5c0-.621.504-1.125 1.125-1.125m18.375 2.625V5.625m0 12.75c0 .621-.504 1.125-1.125 1.125m1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125m0 3.75h-1.5A1.125 1.125 0 0118 18.375M20.625 4.5H3.375m17.25 0c.621 0 1.125.504 1.125 1.125M20.625 4.5h-1.5C18.504 4.5 18 5.004 18 5.625m3.75 0v1.5c0 .621-.504 1.125-1.125 1.125M3.375 4.5c-.621 0-1.125.504-1.125 1.125M3.375 4.5h1.5C5.496 4.5 6 5.004 6 5.625m-3.75 0v1.5c0 .621.504 1.125 1.125 1.125" />
                    </svg>
                </div>
            </div>
            <div class="mt-4 flex items-center gap-2">
                <span class="text-success-400 text-sm font-medium">Available</span>
            </div>
        </div>

        <div class="stat-card group">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm font-medium">Series</p>
                    <p class="text-3xl font-bold text-white mt-2" id="stat-series">-</p>
                </div>
                <div class="stat-card-icon bg-success-500/10 group-hover:bg-success-500/20 transition-colors">
                    <svg class="w-6 h-6 text-success-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 20.25h12m-7.5-3v3m3-3v3m-10.125-3h17.25c.621 0 1.125-.504 1.125-1.125V4.875c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125z" />
                    </svg>
                </div>
            </div>
            <div class="mt-4 flex items-center gap-2">
                <span class="text-success-400 text-sm font-medium">Available</span>
            </div>
        </div>

        <div class="stat-card group">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm font-medium">Live TV</p>
                    <p class="text-3xl font-bold text-white mt-2" id="stat-livetv">-</p>
                </div>
                <div class="stat-card-icon bg-purple-500/10 group-hover:bg-purple-500/20 transition-colors">
                    <svg class="w-6 h-6 text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.348 14.651a3.75 3.75 0 010-5.303m5.304 0a3.75 3.75 0 010 5.303m-7.425 2.122a6.75 6.75 0 010-9.546m9.546 0a6.75 6.75 0 010 9.546" />
                    </svg>
                </div>
            </div>
            <div class="mt-4 flex items-center gap-2">
                <span class="text-gray-500 text-sm font-medium">Channels</span>
            </div>
        </div>

        <div class="stat-card group">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm font-medium">Downloads</p>
                    <p class="text-3xl font-bold text-white mt-2" id="stat-downloads">-</p>
                </div>
                <div class="stat-card-icon bg-warning-500/10 group-hover:bg-warning-500/20 transition-colors">
                    <svg class="w-6 h-6 text-warning-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                    </svg>
                </div>
            </div>
            <div class="mt-4 flex items-center gap-2">
                <span class="text-warning-400 text-sm font-medium">Completed</span>
            </div>
        </div>
    </div>

    <!-- Scheduled Recordings -->
    <div class="card mb-8">
        <div class="flex items-center justify-between p-5 border-b border-gray-800/50">
            <h2 class="text-lg font-semibold text-white">Recordings</h2>
            <a href="/epg" class="section-link">
                View EPG
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
            </a>
        </div>
        <div class="p-5" id="dashboard-recordings">
            <div class="empty-state py-8">
                <div class="empty-state-icon">
                    <svg class="w-8 h-8 text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                        <circle cx="10" cy="10" r="6" />
                    </svg>
                </div>
                <p class="empty-state-title">No scheduled recordings</p>
                <p class="empty-state-text">Schedule recordings from the EPG guide</p>
            </div>
        </div>
    </div>

    <!-- Active Downloads -->
    <div class="card mb-8">
        <div class="flex items-center justify-between p-5 border-b border-gray-800/50">
            <h2 class="text-lg font-semibold text-white">Active Downloads</h2>
            <a href="/downloads" class="section-link">
                View all
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
            </a>
        </div>
        <div class="p-5" id="active-downloads">
            <div class="empty-state py-8">
                <div class="empty-state-icon">
                    <svg class="w-8 h-8 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                    </svg>
                </div>
                <p class="empty-state-title">No active downloads</p>
                <p class="empty-state-text">Downloads will appear here when you request content</p>
            </div>
        </div>
    </div>

</div>

<script>
    // Load stats on page load
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            const response = await fetch('/api/stats');
            const stats = await response.json();

            document.getElementById('stat-movies').textContent = stats.totalMovies?.toLocaleString() || '0';
            document.getElementById('stat-series').textContent = stats.totalSeries?.toLocaleString() || '0';
            document.getElementById('stat-livetv').textContent = stats.totalLiveTV?.toLocaleString() || '0';
            document.getElementById('stat-downloads').textContent = stats.totalDownloads?.toLocaleString() || '0';

            if (stats.activeDownloads > 0) {
                document.getElementById('download-badge').textContent = stats.activeDownloads;
                document.getElementById('download-badge').classList.remove('hidden');
            }
        } catch (err) {
            console.error('Failed to load stats:', err);
        }
    });

    // Quick search
    document.getElementById('quick-search').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            window.location.href = '/movies?search=' + encodeURIComponent(e.target.value);
        }
    });

    // Load recordings
    async function loadDashboardRecordings() {
        try {
            const resp = await fetch('/api/recordings?upcoming=true');
            const recordings = await resp.json();

            const container = document.getElementById('dashboard-recordings');
            if (!recordings || recordings.length === 0) {
                container.innerHTML = \`
                    <div class="empty-state py-8">
                        <div class="empty-state-icon">
                            <svg class="w-8 h-8 text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                                <circle cx="10" cy="10" r="6" />
                            </svg>
                        </div>
                        <p class="empty-state-title">No scheduled recordings</p>
                        <p class="empty-state-text">Schedule recordings from the EPG guide</p>
                    </div>
                \`;
                return;
            }

            container.innerHTML = \`<div class="space-y-3">\` + recordings.map(rec => {
                const endTime = new Date(rec.end_time);
                const endTimeStr = endTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const isRecording = rec.status === 'recording';
                const isScheduled = rec.status === 'scheduled';

                let durationHtml = '';
                if (isRecording && rec.actual_start_time) {
                    durationHtml = \`<span class="recording-duration text-white text-sm font-mono" data-start="\${rec.actual_start_time}">0:00</span>\`;
                }

                // Action buttons based on status
                let actionsHtml = \`<div class="flex items-center gap-1">\`;
                if (isRecording) {
                    // Stop button for active recordings
                    actionsHtml += \`
                        <button onclick="stopRecording(\${rec.id})" class="p-1.5 rounded hover:bg-gray-700 text-yellow-400 hover:text-yellow-300" title="Stop Recording">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <rect x="6" y="6" width="8" height="8" rx="1"/>
                            </svg>
                        </button>\`;
                } else if (isScheduled) {
                    // Cancel button for scheduled recordings
                    actionsHtml += \`
                        <button onclick="cancelRecording(\${rec.id})" class="p-1.5 rounded hover:bg-gray-700 text-gray-400 hover:text-white" title="Cancel">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>\`;
                }
                // Delete button for all
                actionsHtml += \`
                    <button onclick="deleteRecording(\${rec.id})" class="p-1.5 rounded hover:bg-gray-700 text-red-400 hover:text-red-300" title="Delete">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                    </button>\`;
                actionsHtml += \`</div>\`;

                return \`
                    <div class="flex items-center gap-4 p-3 rounded-lg \${isRecording ? 'border border-red-500/30' : ''}" style="background-color: #1f2937;">
                        <div class="w-3 h-3 rounded-full flex-shrink-0 \${isRecording ? 'bg-red-500 animate-pulse' : 'bg-blue-500'}"></div>
                        <div class="flex-1 min-w-0">
                            <h4 class="text-white text-sm font-medium truncate">\${rec.title}</h4>
                            <p class="text-gray-400 text-xs">\${rec.channel_name || 'Channel'} &bull; ends \${endTimeStr}</p>
                        </div>
                        \${durationHtml}
                        <span class="px-2 py-1 rounded text-xs font-medium flex-shrink-0 \${isRecording ? 'bg-red-500/20 text-red-400' : 'bg-blue-500/20 text-blue-400'}">\${rec.status}</span>
                        \${actionsHtml}
                    </div>
                \`;
            }).join('') + \`</div>\`;
        } catch (err) {
            console.error('Failed to load recordings:', err);
        }
    }

    // Update recording durations
    function updateDashboardDurations() {
        document.querySelectorAll('.recording-duration').forEach(el => {
            const startTime = new Date(el.dataset.start);
            const elapsed = Math.floor((Date.now() - startTime.getTime()) / 1000);
            const hours = Math.floor(elapsed / 3600);
            const mins = Math.floor((elapsed % 3600) / 60);
            const secs = elapsed % 60;

            if (hours > 0) {
                el.textContent = \`\${hours}:\${mins.toString().padStart(2, '0')}:\${secs.toString().padStart(2, '0')}\`;
            } else {
                el.textContent = \`\${mins}:\${secs.toString().padStart(2, '0')}\`;
            }
        });
    }

    // Load recordings on page load and refresh periodically
    loadDashboardRecordings();
    setInterval(loadDashboardRecordings, 30000);
    setInterval(updateDashboardDurations, 1000);

    // Recording actions
    async function stopRecording(id) {
        if (!confirm('Stop this recording?')) return;
        try {
            const resp = await fetch('/api/recordings/' + id + '/stop', { method: 'POST' });
            if (resp.ok) {
                if (window.showToast) showToast('Recording stopped', 'success');
                loadDashboardRecordings();
            } else {
                const data = await resp.json();
                throw new Error(data.error || 'Failed to stop');
            }
        } catch (err) {
            console.error('Failed to stop recording:', err);
            if (window.showToast) showToast('Failed to stop recording: ' + err.message, 'error');
        }
    }

    async function cancelRecording(id) {
        if (!confirm('Cancel this scheduled recording?')) return;
        try {
            const resp = await fetch('/api/recordings/' + id + '/cancel', { method: 'POST' });
            if (resp.ok) {
                if (window.showToast) showToast('Recording cancelled', 'success');
                loadDashboardRecordings();
            } else {
                const data = await resp.json();
                throw new Error(data.error || 'Failed to cancel');
            }
        } catch (err) {
            console.error('Failed to cancel recording:', err);
            if (window.showToast) showToast('Failed to cancel recording: ' + err.message, 'error');
        }
    }

    async function deleteRecording(id) {
        if (!confirm('Delete this recording? This will also delete the recorded file.')) return;
        try {
            const resp = await fetch('/api/recordings/' + id + '?deleteFile=true', { method: 'DELETE' });
            if (resp.ok) {
                if (window.showToast) showToast('Recording deleted', 'success');
                loadDashboardRecordings();
            } else {
                const data = await resp.json();
                throw new Error(data.error || 'Failed to delete');
            }
        } catch (err) {
            console.error('Failed to delete recording:', err);
            if (window.showToast) showToast('Failed to delete recording: ' + err.message, 'error');
        }
    }
</script>
` }) %>
