<%- include('layouts/main', { title: 'Home', page: 'dashboard', body: `

<!-- Hero Carousel Section -->
<div id="hero-section">
    <!-- Will be populated by JavaScript -->
    <div class="hero-carousel">
        <div class="hero-slide active" style="background: linear-gradient(135deg, #1a1a2e 0%, #0f0f23 100%);">
            <div class="hero-gradient"></div>
            <div class="hero-content">
                <div class="flex items-center gap-4 mb-6">
                    <div class="skeleton w-32 h-8 rounded"></div>
                </div>
                <div class="skeleton w-96 h-12 rounded mb-4"></div>
                <div class="skeleton w-64 h-4 rounded mb-4"></div>
                <div class="skeleton w-full max-w-xl h-16 rounded mb-6"></div>
                <div class="flex gap-3">
                    <div class="skeleton w-36 h-12 rounded-lg"></div>
                    <div class="skeleton w-36 h-12 rounded-lg"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Content Grid Sections -->
<div class="content-container pb-24" id="content-sections">
    <!-- Loading skeleton -->
    <section class="home-section">
        <div class="home-section-header">
            <div class="skeleton w-48 h-7 rounded"></div>
        </div>
        <div class="media-grid">
            <div class="content-card"><div class="skeleton-card"></div></div>
            <div class="content-card"><div class="skeleton-card"></div></div>
            <div class="content-card"><div class="skeleton-card"></div></div>
            <div class="content-card"><div class="skeleton-card"></div></div>
            <div class="content-card"><div class="skeleton-card"></div></div>
            <div class="content-card"><div class="skeleton-card"></div></div>
        </div>
    </section>
</div>

<!-- Quick Stats Bar (at bottom) -->
<div class="fixed bottom-0 left-0 right-0 bg-dark-bg/95 backdrop-blur-xl border-t border-dark-border z-40 hidden md:block">
    <div class="max-w-screen-2xl mx-auto px-8 py-3 flex items-center justify-between">
        <div class="flex items-center gap-8">
            <a href="/movies" class="flex items-center gap-2 text-text-secondary hover:text-white transition-colors">
                <span class="text-2xl font-bold text-white" id="stat-movies">-</span>
                <span class="text-sm">Movies</span>
            </a>
            <a href="/series" class="flex items-center gap-2 text-text-secondary hover:text-white transition-colors">
                <span class="text-2xl font-bold text-white" id="stat-series">-</span>
                <span class="text-sm">Series</span>
            </a>
            <a href="/livetv" class="flex items-center gap-2 text-text-secondary hover:text-white transition-colors">
                <span class="text-2xl font-bold text-white" id="stat-livetv">-</span>
                <span class="text-sm">Live TV</span>
            </a>
        </div>
        <div class="flex items-center gap-4">
            <a href="/downloads" class="flex items-center gap-2 text-text-secondary hover:text-white transition-colors">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                </svg>
                <span id="stat-downloads">-</span> Downloads
            </a>
            <div id="active-indicator" class="hidden">
                <span class="flex items-center gap-2 text-primary-500">
                    <span class="w-2 h-2 rounded-full bg-primary-500 animate-pulse"></span>
                    <span id="stat-active">0</span> Active
                </span>
            </div>
        </div>
    </div>
</div>

<style>
    .home-section {
        margin-bottom: 2.5rem;
    }

    .home-section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1.25rem;
    }

    .home-section-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: white;
    }

    .home-section-link {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #808080;
        font-size: 0.875rem;
        font-weight: 500;
        transition: color 0.2s;
    }

    .home-section-link:hover {
        color: #E50914;
    }

    .home-section-link svg {
        width: 16px;
        height: 16px;
    }
</style>

<script>
    // Proxy image helper
    function proxyImage(url) {
        if (!url) return '/static/images/no-poster.png';
        return '/api/proxy/image?url=' + encodeURIComponent(url);
    }

    // Load featured content for hero
    async function loadHero() {
        try {
            const response = await fetch('/api/featured?limit=6');
            const featured = await response.json();

            if (!featured || featured.length === 0) {
                document.getElementById('hero-section').innerHTML = '';
                return;
            }

            const heroHtml = \`
                <div class="hero-carousel" id="hero-carousel">
                    \${featured.map((item, index) => \`
                        <div class="hero-slide \${index === 0 ? 'active' : ''}"
                             data-index="\${index}"
                             style="background-image: url('\${proxyImage(item.backdrop_url)}');">
                            <div class="hero-gradient"></div>
                            <div class="hero-gradient-top"></div>
                            <div class="hero-content">
                                <h1 class="hero-title">\${item.title}</h1>
                                <div class="hero-meta">
                                    \${item.rating ? \`
                                        <span class="hero-rating">
                                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                            </svg>
                                            \${item.rating.toFixed(1)}
                                        </span>
                                    \` : ''}
                                    \${item.year ? \`<span class="hero-meta-item">\${item.year}</span>\` : ''}
                                    \${item.genres ? \`<span class="hero-meta-item">\${item.genres.split(',').slice(0, 2).join(', ')}</span>\` : ''}
                                </div>
                                \${item.overview ? \`<p class="hero-description">\${item.overview}</p>\` : ''}
                                <div class="hero-actions">
                                    \${item.trailer_url ? \`
                                        <button class="btn-hero-primary" onclick="playTrailer('\${item.trailer_url}')">
                                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"/>
                                            </svg>
                                            Play Trailer
                                        </button>
                                    \` : ''}
                                    <a href="/\${item.media_type === 'movie' ? 'movies' : 'series'}/\${item.id}" class="btn-hero-secondary">
                                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                        More Info
                                    </a>
                                </div>
                            </div>
                        </div>
                    \`).join('')}
                    \${featured.length > 1 ? \`
                        <div class="hero-indicators">
                            \${featured.map((_, i) => \`
                                <button class="hero-dot \${i === 0 ? 'active' : ''}"
                                        data-index="\${i}"
                                        onclick="goToSlide(\${i})"
                                        aria-label="Go to slide \${i + 1}"></button>
                            \`).join('')}
                        </div>
                    \` : ''}
                </div>
            \`;

            document.getElementById('hero-section').innerHTML = heroHtml;
            initCarousel();
        } catch (err) {
            console.error('Failed to load hero:', err);
        }
    }

    // Initialize carousel
    function initCarousel() {
        const carousel = document.getElementById('hero-carousel');
        if (!carousel) return;

        const slides = carousel.querySelectorAll('.hero-slide');
        const dots = carousel.querySelectorAll('.hero-dot');
        let currentIndex = 0;
        let autoplayInterval;

        window.goToSlide = function(index) {
            slides.forEach((slide, i) => slide.classList.toggle('active', i === index));
            dots.forEach((dot, i) => dot.classList.toggle('active', i === index));
            currentIndex = index;
            resetAutoplay();
        };

        function nextSlide() {
            goToSlide((currentIndex + 1) % slides.length);
        }

        function startAutoplay() {
            autoplayInterval = setInterval(nextSlide, 8000);
        }

        function resetAutoplay() {
            clearInterval(autoplayInterval);
            startAutoplay();
        }

        if (slides.length > 1) {
            startAutoplay();
            carousel.addEventListener('mouseenter', () => clearInterval(autoplayInterval));
            carousel.addEventListener('mouseleave', startAutoplay);
        }
    }

    // Create card HTML
    function createCard(item) {
        const posterUrl = item.poster_url ? proxyImage(item.poster_url) : '/static/images/no-poster.png';
        const link = item.media_type === 'movie' ? '/movies/' + item.id : '/series/' + item.id;

        return \`
            <a href="\${link}" class="content-card">
                <div class="card-poster">
                    <img src="\${posterUrl}"
                         alt="\${item.title}"
                         loading="lazy"
                         onerror="this.src='/static/images/no-poster.png'">
                    \${item.quality ? \`<span class="quality-badge">\${item.quality}</span>\` : ''}
                    <div class="card-overlay">
                        <div class="play-btn">
                            <svg class="w-5 h-5 ml-0.5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                    </div>
                </div>
                <div class="card-info">
                    <h3 class="card-title">\${item.title}</h3>
                    <p class="card-meta">
                        \${item.year || ''}
                        \${item.rating ? \`
                            <span class="flex items-center gap-0.5">
                                <svg class="w-3 h-3 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                </svg>
                                \${item.rating.toFixed ? item.rating.toFixed(1) : item.rating}
                            </span>
                        \` : ''}
                    </p>
                </div>
            </a>
        \`;
    }

    // Load content sections (grid view)
    async function loadContentSections() {
        try {
            const response = await fetch('/api/content/rows');
            const sections = await response.json();

            if (!sections || sections.length === 0) {
                document.getElementById('content-sections').innerHTML = \`
                    <div class="empty-state py-16">
                        <div class="empty-state-icon">
                            <svg class="w-8 h-8 text-text-muted" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3.375 19.5h17.25m-17.25 0a1.125 1.125 0 01-1.125-1.125M3.375 19.5h1.5C5.496 19.5 6 18.996 6 18.375m-3.75 0V5.625"/>
                            </svg>
                        </div>
                        <p class="empty-state-title">No content yet</p>
                        <p class="empty-state-text">Add IPTV sources in Settings to populate your library</p>
                        <a href="/settings" class="btn btn-primary mt-4">Go to Settings</a>
                    </div>
                \`;
                return;
            }

            const sectionsHtml = sections.map(section => \`
                <section class="home-section">
                    <div class="home-section-header">
                        <h2 class="home-section-title">\${section.title}</h2>
                        \${section.link ? \`
                            <a href="\${section.link}" class="home-section-link">
                                See All
                                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/>
                                </svg>
                            </a>
                        \` : ''}
                    </div>
                    <div class="media-grid">
                        \${section.items.map(item => createCard(item)).join('')}
                    </div>
                </section>
            \`).join('');

            document.getElementById('content-sections').innerHTML = sectionsHtml;
        } catch (err) {
            console.error('Failed to load content sections:', err);
        }
    }

    // Play trailer function
    window.playTrailer = function(url) {
        const embedUrl = url.includes('youtube.com/watch')
            ? url.replace('watch?v=', 'embed/') + '?autoplay=1'
            : url;

        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/90 z-modal flex items-center justify-center p-4';
        modal.innerHTML = \`
            <div class="relative w-full max-w-5xl aspect-video bg-dark-card rounded-xl overflow-hidden">
                <button onclick="this.closest('.fixed').remove()"
                        class="absolute top-4 right-4 z-10 w-10 h-10 rounded-full bg-black/50 text-white flex items-center justify-center hover:bg-black/70">
                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
                <iframe src="\${embedUrl}"
                        class="w-full h-full"
                        frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen></iframe>
            </div>
        \`;
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
        document.body.appendChild(modal);
    };

    // Load stats
    async function loadStats() {
        try {
            const response = await fetch('/api/stats');
            const stats = await response.json();

            document.getElementById('stat-movies').textContent = stats.totalMovies?.toLocaleString() || '0';
            document.getElementById('stat-series').textContent = stats.totalSeries?.toLocaleString() || '0';
            document.getElementById('stat-livetv').textContent = stats.totalLiveTV?.toLocaleString() || '0';
            document.getElementById('stat-downloads').textContent = stats.totalDownloads?.toLocaleString() || '0';

            if (stats.activeDownloads > 0) {
                document.getElementById('stat-active').textContent = stats.activeDownloads;
                document.getElementById('active-indicator').classList.remove('hidden');
                // Also update header badge
                const badge = document.getElementById('download-badge');
                if (badge) {
                    badge.textContent = stats.activeDownloads;
                    badge.classList.remove('hidden');
                }
            }
        } catch (err) {
            console.error('Failed to load stats:', err);
        }
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', () => {
        loadHero();
        loadContentSections();
        loadStats();
    });
</script>

` }) %>
