<%- include('layouts/main', { title: 'Live TV', body: `
<!-- Mini Hero -->
<section class="mini-hero" id="mini-hero">
    <div class="mini-hero-bg" style="background-image: url('/static/images/livetv-hero.jpg');"></div>
    <div class="mini-hero-gradient"></div>
    <div class="mini-hero-content">
        <h1 class="text-4xl font-bold mb-2">Live TV</h1>
        <p class="text-text-muted" id="page-subtitle">Select a category to browse channels</p>
    </div>
</section>

<div class="content-container">
    <!-- Filter Bar -->
    <div class="filter-bar">
        <div class="filter-bar-inner">
            <!-- Search -->
            <div class="filter-search">
                <svg class="filter-search-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <input type="text" id="search-input" placeholder="Search channels or categories..." class="filter-search-input" />
            </div>

            <!-- Country Filter -->
            <select id="country-filter" class="filter-select" style="min-width: 160px;">
                <option value="">All Countries</option>
            </select>

            <!-- Back Button (when viewing channels) -->
            <button id="back-btn" class="btn-hero-secondary hidden">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                Back to Categories
            </button>

            <!-- Count -->
            <div class="filter-actions">
                <span class="result-count">
                    <span id="results-count">0</span> <span id="results-label">categories</span>
                </span>
            </div>
        </div>
    </div>

    <!-- Categories View (initial, shows horizontal rows by region) -->
    <div id="categories-view" class="livetv-categories"></div>

    <!-- Channels View (when category selected) -->
    <div id="channels-view" class="hidden">
        <div class="livetv-channels-grid" id="channels-grid"></div>
        <div class="mt-8 text-center">
            <button id="load-more" class="btn-hero-secondary hidden">Load More Channels</button>
        </div>
    </div>

    <!-- Empty State -->
    <div class="empty-state hidden" id="empty-state">
        <div class="empty-state-icon">
            <svg class="w-12 h-12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 20.25h12m-7.5-3v3m3-3v3m-10.125-3h17.25c.621 0 1.125-.504 1.125-1.125V4.875c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125z" />
            </svg>
        </div>
        <p class="empty-state-title">No channels found</p>
        <p class="empty-state-text">Try a different search term</p>
    </div>
</div>

<!-- Context Menu -->
<div id="context-menu" class="fixed bg-dark-card border border-dark-border rounded-lg shadow-2xl py-2 z-50 hidden min-w-[180px]">
    <button id="ctx-play" class="w-full px-4 py-2.5 text-left text-white flex items-center gap-3 hover:bg-dark-surface transition-colors">
        <svg class="w-4 h-4 text-primary-500" fill="currentColor" viewBox="0 0 24 24">
            <path d="M8 5v14l11-7z"/>
        </svg>
        Play in VLC
    </button>
    <button id="ctx-record" class="w-full px-4 py-2.5 text-left text-white flex items-center gap-3 hover:bg-dark-surface transition-colors">
        <svg class="w-4 h-4 text-danger-500" fill="currentColor" viewBox="0 0 20 20">
            <circle cx="10" cy="10" r="6"/>
        </svg>
        Record...
    </button>
    <div class="border-t border-dark-border my-1"></div>
    <button id="ctx-copy" class="w-full px-4 py-2.5 text-left text-white flex items-center gap-3 hover:bg-dark-surface transition-colors">
        <svg class="w-4 h-4 text-text-muted" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
        </svg>
        Copy Stream URL
    </button>
</div>

<!-- Recording Modal -->
<div id="record-modal" class="modal-overlay hidden">
    <div class="modal-content max-w-md p-6">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold text-white">Schedule Recording</h3>
            <button onclick="closeRecordModal()" class="text-text-muted hover:text-white transition-colors">
                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <!-- Channel Info -->
        <div class="flex items-center gap-4 mb-6 p-4 rounded-lg bg-dark-surface">
            <img id="record-channel-logo" src="/static/img/no-logo.png" class="w-12 h-12 rounded-lg object-contain bg-dark-border" onerror="this.src='/static/img/no-logo.png'" />
            <div class="flex-1 min-w-0">
                <h4 id="record-channel-name" class="text-white font-medium truncate"></h4>
                <p id="record-channel-category" class="text-text-muted text-sm truncate"></p>
            </div>
        </div>

        <!-- Duration Selection -->
        <div class="mb-6">
            <label class="block text-text-secondary text-sm font-medium mb-3">Recording Duration</label>
            <div class="grid grid-cols-4 gap-2 mb-4">
                <button type="button" class="duration-btn btn btn-secondary py-2 text-sm" data-minutes="30">30 min</button>
                <button type="button" class="duration-btn btn btn-secondary py-2 text-sm" data-minutes="60">1 hour</button>
                <button type="button" class="duration-btn btn btn-secondary py-2 text-sm" data-minutes="90">1.5 hr</button>
                <button type="button" class="duration-btn btn btn-secondary py-2 text-sm" data-minutes="120">2 hours</button>
            </div>
            <div class="flex items-center gap-4">
                <div class="flex-1">
                    <label class="block text-text-muted text-xs mb-1">Or set end time</label>
                    <input type="time" id="record-end-time" class="input w-full" />
                </div>
                <div class="flex-1">
                    <label class="block text-text-muted text-xs mb-1">Calculated end</label>
                    <p id="record-end-display" class="text-white font-medium py-2">--:--</p>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="flex gap-3">
            <button onclick="closeRecordModal()" class="btn btn-secondary flex-1">Cancel</button>
            <button onclick="startRecording()" class="btn btn-danger flex-1">
                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <circle cx="10" cy="10" r="6"/>
                </svg>
                Start Recording
            </button>
        </div>
    </div>
</div>

<script>
    let currentOffset = 0;
    const limit = 100;
    let loading = false;
    let currentCategory = null;
    let allCategories = [];
    let currentCountry = '';
    let preferredLanguages = [];

    const countryNames = {
        'DE': 'Germany', 'US': 'United States', 'UK': 'United Kingdom', 'FR': 'France',
        'ES': 'Spain', 'IT': 'Italy', 'NL': 'Netherlands', 'PL': 'Poland',
        'TR': 'Turkey', 'PT': 'Portugal', 'GR': 'Greece', 'RU': 'Russia',
        'AT': 'Austria', 'CH': 'Switzerland', 'BE': 'Belgium', 'CA': 'Canada',
        'AU': 'Australia', 'BR': 'Brazil', 'MX': 'Mexico', 'AR': 'Argentina',
        'IN': 'India', 'JP': 'Japan', 'KR': 'South Korea', 'CN': 'China',
        'SE': 'Sweden', 'NO': 'Norway', 'DK': 'Denmark', 'FI': 'Finland',
        'RO': 'Romania', 'HU': 'Hungary', 'CZ': 'Czech Republic', 'SK': 'Slovakia',
        'HR': 'Croatia', 'RS': 'Serbia', 'BG': 'Bulgaria', 'UA': 'Ukraine',
        'AL': 'Albania', 'IR': 'Iran', 'IL': 'Israel', 'SA': 'Saudi Arabia',
        'AE': 'UAE', 'EG': 'Egypt', 'ZA': 'South Africa', 'NG': 'Nigeria',
        'LA': 'Latin America', 'EU': 'Europe', 'AF': 'Africa', 'IA': 'India/Asia',
        'IE': 'Ireland', 'OTHER': 'Other'
    };

    const countryFlags = {
        'DE': '\u{1F1E9}\u{1F1EA}', 'US': '\u{1F1FA}\u{1F1F8}', 'UK': '\u{1F1EC}\u{1F1E7}', 'FR': '\u{1F1EB}\u{1F1F7}',
        'ES': '\u{1F1EA}\u{1F1F8}', 'IT': '\u{1F1EE}\u{1F1F9}', 'NL': '\u{1F1F3}\u{1F1F1}', 'PL': '\u{1F1F5}\u{1F1F1}',
        'TR': '\u{1F1F9}\u{1F1F7}', 'PT': '\u{1F1F5}\u{1F1F9}', 'GR': '\u{1F1EC}\u{1F1F7}', 'RU': '\u{1F1F7}\u{1F1FA}',
        'AT': '\u{1F1E6}\u{1F1F9}', 'CH': '\u{1F1E8}\u{1F1ED}', 'BE': '\u{1F1E7}\u{1F1EA}', 'CA': '\u{1F1E8}\u{1F1E6}',
        'AU': '\u{1F1E6}\u{1F1FA}', 'BR': '\u{1F1E7}\u{1F1F7}', 'MX': '\u{1F1F2}\u{1F1FD}', 'AR': '\u{1F1E6}\u{1F1F7}',
        'IN': '\u{1F1EE}\u{1F1F3}', 'JP': '\u{1F1EF}\u{1F1F5}', 'KR': '\u{1F1F0}\u{1F1F7}', 'CN': '\u{1F1E8}\u{1F1F3}',
        'SE': '\u{1F1F8}\u{1F1EA}', 'NO': '\u{1F1F3}\u{1F1F4}', 'DK': '\u{1F1E9}\u{1F1F0}', 'FI': '\u{1F1EB}\u{1F1EE}'
    };

    function getCategoryDisplayName(category) {
        if (!category) return 'Uncategorized';
        let name = category.replace(/^\\|?[A-Z]{2}\\|\\s*/i, '');
        name = name.replace(/[|#]+/g, ' ').trim();
        return name || category;
    }

    function getCategoryCountry(category) {
        if (!category) return null;
        const match = category.match(/\\|?([A-Z]{2})\\|/i) || category.match(/^([A-Z]{2})\\s/i);
        return match ? match[1].toUpperCase() : null;
    }

    function getCategoryIcon(category) {
        const country = getCategoryCountry(category);
        return countryFlags[country] || '\u{1F4FA}';
    }

    async function loadCategories() {
        try {
            const settingsResp = await fetch('/api/settings');
            const settings = await settingsResp.json();
            preferredLanguages = (settings.preferredLanguages || []).map(l => l.toUpperCase());

            const response = await fetch('/api/filters?type=live');
            const filters = await response.json();
            allCategories = filters.categories.filter(cat => cat);

            if (preferredLanguages.length > 0) {
                allCategories = allCategories.filter(cat => {
                    const country = getCategoryCountry(cat);
                    return country && preferredLanguages.includes(country);
                });
            }

            populateCountryFilter();
            applyFilters();
        } catch (err) {
            console.error('Failed to load categories:', err);
        }
    }

    function populateCountryFilter() {
        const select = document.getElementById('country-filter');
        const countries = new Set();
        allCategories.forEach(cat => {
            const country = getCategoryCountry(cat);
            if (country) countries.add(country);
        });

        const priority = ['DE', 'US', 'UK', 'FR', 'ES', 'IT'];
        const sortedCountries = Array.from(countries).sort((a, b) => {
            const aIdx = priority.indexOf(a);
            const bIdx = priority.indexOf(b);
            if (aIdx !== -1 && bIdx !== -1) return aIdx - bIdx;
            if (aIdx !== -1) return -1;
            if (bIdx !== -1) return 1;
            return a.localeCompare(b);
        });

        select.innerHTML = '<option value="">All Countries</option>';
        sortedCountries.forEach(code => {
            const flag = countryFlags[code] || '';
            const name = countryNames[code] || code;
            select.innerHTML += \`<option value="\${code}">\${flag} \${name}</option>\`;
        });
    }

    function applyFilters() {
        const query = document.getElementById('search-input').value.toLowerCase();
        let filtered = allCategories;

        if (currentCountry) {
            filtered = filtered.filter(cat => getCategoryCountry(cat) === currentCountry);
        }

        if (query) {
            filtered = filtered.filter(cat =>
                cat.toLowerCase().includes(query) ||
                getCategoryDisplayName(cat).toLowerCase().includes(query)
            );
        }

        renderCategories(filtered);
    }

    // Country colors for gradient backgrounds
    const countryColors = {
        'DE': { from: '#000000', to: '#DD0000', accent: '#FFCC00' },
        'US': { from: '#002868', to: '#BF0A30', accent: '#FFFFFF' },
        'UK': { from: '#00247D', to: '#CF142B', accent: '#FFFFFF' },
        'FR': { from: '#002395', to: '#ED2939', accent: '#FFFFFF' },
        'ES': { from: '#AA151B', to: '#F1BF00', accent: '#FFFFFF' },
        'IT': { from: '#009246', to: '#CE2B37', accent: '#FFFFFF' },
        'NL': { from: '#21468B', to: '#AE1C28', accent: '#FFFFFF' },
        'PL': { from: '#DC143C', to: '#FFFFFF', accent: '#DC143C' },
        'TR': { from: '#E30A17', to: '#E30A17', accent: '#FFFFFF' },
        'PT': { from: '#006600', to: '#FF0000', accent: '#FFCC00' },
        'BR': { from: '#009739', to: '#FEDD00', accent: '#002776' },
        'default': { from: '#667eea', to: '#764ba2', accent: '#FFFFFF' }
    };

    function getCountryColors(country) {
        return countryColors[country] || countryColors['default'];
    }

    async function fetchChannelCounts() {
        try {
            const response = await fetch('/api/livetv/counts');
            return await response.json();
        } catch (e) {
            return {};
        }
    }

    async function renderCategories(categories) {
        const container = document.getElementById('categories-view');
        container.innerHTML = '';

        // Fetch channel counts per category
        const channelCounts = await fetchChannelCounts();

        // Group by country
        const grouped = {};
        categories.forEach(cat => {
            const country = getCategoryCountry(cat) || 'OTHER';
            if (!grouped[country]) grouped[country] = [];
            grouped[country].push(cat);
        });

        const priority = ['DE', 'US', 'UK', 'FR', 'ES', 'IT'];
        const sortedCountries = Object.keys(grouped).sort((a, b) => {
            const aIdx = priority.indexOf(a);
            const bIdx = priority.indexOf(b);
            if (aIdx !== -1 && bIdx !== -1) return aIdx - bIdx;
            if (aIdx !== -1) return -1;
            if (bIdx !== -1) return 1;
            if (a === 'OTHER') return 1;
            if (b === 'OTHER') return -1;
            return a.localeCompare(b);
        });

        // Create horizontal rows for each country
        sortedCountries.forEach(country => {
            const countryCategories = grouped[country];
            const countryName = countryNames[country] || country;
            const flag = countryFlags[country] || '';
            const colors = getCountryColors(country);
            const totalChannels = countryCategories.reduce((sum, cat) => sum + (channelCounts[cat] || 0), 0);

            const cards = countryCategories.map(cat => {
                const displayName = getCategoryDisplayName(cat);
                const count = channelCounts[cat] || 0;
                return \`
                <div class="livetv-category-card" onclick="selectCategory('\${cat.replace(/'/g, "\\\\'")}')">
                    <div class="livetv-category-bg" style="background: linear-gradient(135deg, \${colors.from}22 0%, \${colors.to}22 100%);"></div>
                    <div class="livetv-category-content">
                        <div class="livetv-category-icon">\${getCategoryIcon(cat)}</div>
                        <div class="livetv-category-info">
                            <h3 class="livetv-category-name">\${displayName}</h3>
                            <span class="livetv-category-count">\${count > 0 ? count + ' channels' : ''}</span>
                        </div>
                        <div class="livetv-category-arrow">
                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/>
                            </svg>
                        </div>
                    </div>
                </div>
            \`}).join('');

            container.innerHTML += \`
                <section class="livetv-country-section">
                    <div class="livetv-country-header">
                        <div class="livetv-country-title">
                            <span class="livetv-country-flag">\${flag}</span>
                            <h2>\${countryName}</h2>
                        </div>
                        <span class="livetv-country-total">\${totalChannels > 0 ? totalChannels + ' channels' : ''}</span>
                    </div>
                    <div class="livetv-category-grid">\${cards}</div>
                </section>
            \`;
        });

        document.getElementById('results-count').textContent = categories.length;
        document.getElementById('results-label').textContent = 'categories';
    }

    window.scrollRow = function(btn, direction) {
        const track = btn.parentElement.querySelector('.livetv-category-track');
        const cardWidth = track.querySelector('.livetv-category-card')?.offsetWidth || 200;
        const scrollAmount = (cardWidth + 16) * 3 * direction;
        track.scrollBy({ left: scrollAmount, behavior: 'smooth' });
    };

    function selectCategory(category) {
        currentCategory = category;
        currentOffset = 0;

        document.getElementById('categories-view').classList.add('hidden');
        document.getElementById('channels-view').classList.remove('hidden');
        document.getElementById('back-btn').classList.remove('hidden');
        document.getElementById('page-subtitle').textContent = getCategoryDisplayName(category);
        document.getElementById('results-label').textContent = 'channels';
        document.getElementById('search-input').placeholder = 'Search in ' + getCategoryDisplayName(category) + '...';
        document.getElementById('search-input').value = '';

        loadChannels(true);
    }

    function showCategories() {
        currentCategory = null;
        currentOffset = 0;

        document.getElementById('categories-view').classList.remove('hidden');
        document.getElementById('channels-view').classList.add('hidden');
        document.getElementById('back-btn').classList.add('hidden');
        document.getElementById('page-subtitle').textContent = 'Select a category to browse channels';
        document.getElementById('results-label').textContent = 'categories';
        document.getElementById('search-input').placeholder = 'Search channels or categories...';
        document.getElementById('search-input').value = '';
        document.getElementById('empty-state').classList.add('hidden');

        applyFilters();
    }

    // Smart title cleaning - detects and removes country/language prefixes
    // Handles various IPTV provider formats like: DE ❖ Name, FR - Name, [US] Name, UK: Name, etc.
    function cleanChannelTitle(title) {
        if (!title) return '';

        // Country codes to detect (2-3 letter codes)
        const countryCodes = ['DE', 'FR', 'US', 'UK', 'GB', 'ES', 'IT', 'NL', 'BE', 'AT', 'CH', 'PL', 'PT', 'TR', 'GR', 'RU', 'BR', 'MX', 'AR', 'CA', 'AU', 'IN', 'JP', 'KR', 'CN', 'HK', 'TW', 'SE', 'NO', 'DK', 'FI', 'CZ', 'SK', 'HU', 'RO', 'BG', 'HR', 'SI', 'RS', 'BA', 'AL', 'MK', 'XK', 'ME', 'ENG', 'GER', 'SPA', 'FRA', 'ITA', 'POR', 'DUT', 'POL', 'TUR', 'ARA', 'RUS', 'HIN', 'JPN'];
        const codePattern = countryCodes.join('|');

        // Patterns to match and remove (order matters - more specific first)
        const patterns = [
            // [DE] Name or (DE) Name
            new RegExp(\`^\\\\[(\${codePattern})\\\\]\\\\s*\`, 'i'),
            new RegExp(\`^\\\\((\${codePattern})\\\\)\\\\s*\`, 'i'),
            // DE ❖ Name or DE ✦ Name (special symbols)
            new RegExp(\`^(\${codePattern})\\\\s*[❖✦★●◆◇▶►▷■□☆✧✩✪✫✬✭✮✯✰]\\\\s*\`, 'i'),
            // DE | Name or DE / Name
            new RegExp(\`^(\${codePattern})\\\\s*[|/]\\\\s*\`, 'i'),
            // DE - Name or DE : Name
            new RegExp(\`^(\${codePattern})\\\\s*[-:]\\\\s*\`, 'i'),
            // DE_ Name (underscore separator)
            new RegExp(\`^(\${codePattern})_\\\\s*\`, 'i'),
            // DE Name (just space, but only if followed by uppercase)
            new RegExp(\`^(\${codePattern})\\\\s+(?=[A-Z])\`, 'i'),
        ];

        let cleaned = title.trim();
        for (const pattern of patterns) {
            cleaned = cleaned.replace(pattern, '');
        }

        // Also clean up any trailing quality markers if they're at the start: HD, SD, FHD, 4K
        cleaned = cleaned.replace(/^(HD|SD|FHD|UHD|4K)\\s*[-:|]?\\s*/i, '');

        return cleaned.trim() || title;
    }

    async function loadChannels(reset = false) {
        if (loading) return;
        loading = true;

        if (reset) {
            currentOffset = 0;
            document.getElementById('channels-grid').innerHTML = '';
        }

        const params = new URLSearchParams({
            type: 'live',
            search: document.getElementById('search-input').value,
            category: currentCategory || '',
            limit,
            offset: currentOffset
        });

        try {
            const response = await fetch('/api/media?' + params);
            const data = await response.json();
            const channels = data.items || data;
            const grid = document.getElementById('channels-grid');
            const emptyState = document.getElementById('empty-state');

            if (reset) grid.innerHTML = '';

            if (channels.length === 0 && currentOffset === 0) {
                emptyState.classList.remove('hidden');
                grid.classList.add('hidden');
            } else {
                emptyState.classList.add('hidden');
                grid.classList.remove('hidden');
            }

            channels.forEach((channel, index) => {
                const imgSrc = channel.poster ? proxyImage(channel.poster) : '/static/img/no-logo.png';
                const isEager = currentOffset === 0 && index < 16;
                let displayName = cleanChannelTitle(channel.title);
                const channelJson = JSON.stringify(channel).replace(/"/g, '&quot;');

                grid.innerHTML += \`
                    <div class="livetv-channel-card" oncontextmenu="showContextMenu(event, \${channelJson})">
                        <!-- Live Badge -->
                        <div class="livetv-live-badge">
                            <span class="livetv-live-dot"></span>
                            LIVE
                        </div>

                        <!-- Logo Area -->
                        <div class="livetv-channel-logo">
                            <img src="\${isEager ? imgSrc : '/static/img/no-logo.png'}"
                                 data-src="\${imgSrc}"
                                 alt="\${displayName}"
                                 class="\${isEager ? '' : 'lazy-image'}"
                                 onerror="this.src='/static/img/no-logo.png'" />
                        </div>

                        <!-- Channel Info -->
                        <div class="livetv-channel-info">
                            <h3 class="livetv-channel-name">\${displayName}</h3>
                            <div class="livetv-channel-epg">
                                <span class="livetv-now-label">Now:</span>
                                <span class="livetv-now-title epg-now" data-tvg-id="\${channel.tvg_id || ''}">Loading...</span>
                            </div>
                            <div class="livetv-epg-progress" data-tvg-id-progress="\${channel.tvg_id || ''}">
                                <div class="livetv-epg-progress-bar" style="width: 0%"></div>
                            </div>
                        </div>

                        <!-- Hover Actions -->
                        <div class="livetv-channel-actions">
                            <button class="livetv-action-btn livetv-preview-btn" onclick="event.stopPropagation(); previewChannel(\${channelJson})" title="Preview">
                                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                </svg>
                            </button>
                            <button class="livetv-action-btn livetv-play-btn" onclick="event.stopPropagation(); playChannel(\${channelJson})" title="Play in VLC">
                                <svg fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M8 5v14l11-7z"/>
                                </svg>
                            </button>
                            <button class="livetv-action-btn livetv-record-btn" onclick="event.stopPropagation(); openRecordModal(\${channelJson})" title="Record">
                                <svg fill="currentColor" viewBox="0 0 24 24">
                                    <circle cx="12" cy="12" r="8"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                \`;
            });

            initLazyLoad();

            const tvgIds = channels.filter(c => c.tvg_id).map(c => c.tvg_id);
            if (tvgIds.length > 0) fetchEpgForChannels(tvgIds);

            document.getElementById('results-count').textContent = (currentOffset + channels.length).toLocaleString();
            document.getElementById('load-more').classList.toggle('hidden', channels.length < limit);
            if (channels.length === limit) currentOffset += limit;
        } catch (err) {
            console.error('Failed to load channels:', err);
        }
        loading = false;
    }

    function playChannel(channel) {
        fetch('/api/play', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url: channel.stream_url })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success && window.showToast) showToast('Opening in VLC...', 'success');
            else if (data.error && window.showToast) showToast('Failed to open VLC: ' + data.error, 'error');
        })
        .catch(err => {
            console.error('Failed to open VLC:', err);
            if (window.showToast) showToast('Failed to open VLC', 'error');
        });
    }

    async function fetchEpgForChannels(tvgIds) {
        try {
            const response = await fetch('/api/epg/channels', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ channelIds: tvgIds })
            });
            const epgData = await response.json();

            document.querySelectorAll('.epg-now').forEach(el => {
                const tvgId = el.dataset.tvgId;
                if (tvgId && epgData[tvgId]?.current) {
                    const program = epgData[tvgId].current;
                    el.textContent = program.title;
                    el.title = program.title;

                    // Update progress bar
                    const progressEl = document.querySelector(\`[data-tvg-id-progress="\${tvgId}"] .livetv-epg-progress-bar\`);
                    if (progressEl && program.start && program.end) {
                        const start = new Date(program.start).getTime();
                        const end = new Date(program.end).getTime();
                        const now = Date.now();
                        const progress = Math.min(100, Math.max(0, ((now - start) / (end - start)) * 100));
                        progressEl.style.width = progress + '%';
                    }
                } else if (tvgId) {
                    el.textContent = 'No program info';
                }
            });
        } catch (err) {
            console.error('Failed to fetch EPG:', err);
            document.querySelectorAll('.epg-now').forEach(el => {
                if (el.textContent === 'Loading...') el.textContent = 'No program info';
            });
        }
    }

    // Preview channel in browser
    function previewChannel(channel) {
        if (!channel.stream_url) {
            if (window.showToast) showToast('No stream URL available', 'error');
            return;
        }

        // Use the preview modal from main layout
        if (typeof openPreview === 'function') {
            openPreview(channel.stream_url, channel.title, '', '');
        } else {
            // Fallback to VLC
            playChannel(channel);
        }
    }

    // Event listeners
    document.getElementById('search-input').addEventListener('input', debounce((e) => {
        if (currentCategory) loadChannels(true);
        else applyFilters();
    }, 300));

    document.getElementById('country-filter').addEventListener('change', (e) => {
        currentCountry = e.target.value;
        if (currentCategory) showCategories();
        else applyFilters();
    });

    document.getElementById('back-btn').addEventListener('click', showCategories);
    document.getElementById('load-more').addEventListener('click', () => loadChannels(false));

    // Context menu
    let contextMenuChannel = null;

    function showContextMenu(e, channel) {
        e.preventDefault();
        e.stopPropagation();
        contextMenuChannel = channel;

        const menu = document.getElementById('context-menu');
        menu.classList.remove('hidden');

        let x = e.clientX, y = e.clientY;
        const menuRect = menu.getBoundingClientRect();
        if (x + menuRect.width > window.innerWidth) x = window.innerWidth - menuRect.width - 10;
        if (y + menuRect.height > window.innerHeight) y = window.innerHeight - menuRect.height - 10;

        menu.style.left = x + 'px';
        menu.style.top = y + 'px';
    }

    function hideContextMenu() {
        document.getElementById('context-menu').classList.add('hidden');
        contextMenuChannel = null;
    }

    document.getElementById('ctx-play').addEventListener('click', () => {
        if (contextMenuChannel) playChannel(contextMenuChannel);
        hideContextMenu();
    });

    document.getElementById('ctx-record').addEventListener('click', () => {
        if (contextMenuChannel) openRecordModal(contextMenuChannel);
        hideContextMenu();
    });

    document.getElementById('ctx-copy').addEventListener('click', () => {
        if (contextMenuChannel?.stream_url) {
            navigator.clipboard.writeText(contextMenuChannel.stream_url).then(() => {
                if (window.showToast) showToast('Stream URL copied!', 'success');
            });
        }
        hideContextMenu();
    });

    document.addEventListener('click', (e) => {
        if (!e.target.closest('#context-menu')) hideContextMenu();
    });
    document.addEventListener('scroll', hideContextMenu, true);

    // Recording modal
    let recordChannel = null;
    let recordingEndTime = null;

    function openRecordModal(channel) {
        recordChannel = channel;
        const imgSrc = channel.poster ? proxyImage(channel.poster) : '/static/img/no-logo.png';
        document.getElementById('record-channel-logo').src = imgSrc;
        document.getElementById('record-channel-name').textContent = channel.title;
        document.getElementById('record-channel-category').textContent = channel.category || '';

        document.querySelectorAll('.duration-btn').forEach(btn => btn.classList.remove('btn-primary'));
        recordingEndTime = null;
        document.getElementById('record-end-display').textContent = '--:--';
        document.getElementById('record-end-time').value = '';

        selectDuration(60);
        document.getElementById('record-modal').classList.remove('hidden');
    }

    function closeRecordModal() {
        document.getElementById('record-modal').classList.add('hidden');
        recordChannel = null;
        recordingEndTime = null;
    }

    function selectDuration(minutes) {
        document.querySelectorAll('.duration-btn').forEach(btn => {
            const btnMinutes = parseInt(btn.dataset.minutes);
            btn.classList.toggle('btn-primary', btnMinutes === minutes);
            btn.classList.toggle('btn-secondary', btnMinutes !== minutes);
        });

        const endDate = new Date(Date.now() + minutes * 60 * 1000);
        recordingEndTime = endDate.toISOString();
        document.getElementById('record-end-display').textContent = endDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        document.getElementById('record-end-time').value = '';
    }

    document.querySelectorAll('.duration-btn').forEach(btn => {
        btn.addEventListener('click', () => selectDuration(parseInt(btn.dataset.minutes)));
    });

    document.getElementById('record-end-time').addEventListener('change', (e) => {
        if (e.target.value) {
            document.querySelectorAll('.duration-btn').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
            });

            const [hours, minutes] = e.target.value.split(':').map(Number);
            const endDate = new Date();
            endDate.setHours(hours, minutes, 0, 0);
            if (endDate <= new Date()) endDate.setDate(endDate.getDate() + 1);

            recordingEndTime = endDate.toISOString();
            document.getElementById('record-end-display').textContent = endDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
    });

    async function startRecording() {
        if (!recordChannel || !recordingEndTime) {
            if (window.showToast) showToast('Please select a duration', 'error');
            return;
        }

        try {
            const resp = await fetch('/api/recordings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    mediaId: recordChannel.id,
                    channelTvgId: recordChannel.tvg_id || null,
                    title: recordChannel.title,
                    startTime: new Date().toISOString(),
                    endTime: recordingEndTime
                })
            });

            const result = await resp.json();
            if (resp.ok) {
                if (window.showToast) showToast('Recording started!', 'success');
                closeRecordModal();
            } else {
                throw new Error(result.error || 'Unknown error');
            }
        } catch (err) {
            console.error('Failed to start recording:', err);
            if (window.showToast) showToast('Failed to start recording: ' + err.message, 'error');
        }
    }

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') { closeRecordModal(); hideContextMenu(); }
    });

    document.getElementById('record-modal').addEventListener('click', (e) => {
        if (e.target.id === 'record-modal') closeRecordModal();
    });

    // Initialize
    loadCategories();

    function debounce(func, wait) {
        let timeout;
        return function(e) { clearTimeout(timeout); timeout = setTimeout(() => func(e), wait); };
    }
</script>

<style>
    /* =====================================================
       LIVE TV - CATEGORY STYLES
       ===================================================== */

    .livetv-categories {
        display: flex;
        flex-direction: column;
        gap: 2rem;
    }

    .livetv-country-section {
        margin-bottom: 1rem;
    }

    .livetv-country-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
        padding: 0 0.5rem;
    }

    .livetv-country-title {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .livetv-country-flag {
        font-size: 2rem;
        line-height: 1;
    }

    .livetv-country-title h2 {
        font-size: 1.5rem;
        font-weight: 700;
        color: white;
        margin: 0;
    }

    .livetv-country-total {
        font-size: 0.875rem;
        color: #808080;
        background: rgba(255,255,255,0.05);
        padding: 0.375rem 0.75rem;
        border-radius: 999px;
    }

    /* Category Grid */
    .livetv-category-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
        padding: 0.5rem 0;
    }

    @media (min-width: 640px) {
        .livetv-category-grid {
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        }
    }

    @media (min-width: 1024px) {
        .livetv-category-grid {
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 1.25rem;
        }
    }

    /* Category Card */
    .livetv-category-card {
        position: relative;
        background: #1a1a1a;
        border: 1px solid rgba(255,255,255,0.06);
        border-radius: 12px;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .livetv-category-card:hover {
        transform: translateY(-4px);
        border-color: rgba(229, 9, 20, 0.5);
        box-shadow: 0 12px 40px rgba(0,0,0,0.4), 0 0 0 1px rgba(229, 9, 20, 0.2);
    }

    .livetv-category-bg {
        position: absolute;
        inset: 0;
        opacity: 0.5;
        transition: opacity 0.3s;
    }

    .livetv-category-card:hover .livetv-category-bg {
        opacity: 0.8;
    }

    .livetv-category-content {
        position: relative;
        display: flex;
        align-items: center;
        gap: 0.875rem;
        padding: 1rem;
    }

    .livetv-category-icon {
        font-size: 2rem;
        line-height: 1;
        flex-shrink: 0;
    }

    .livetv-category-info {
        flex: 1;
        min-width: 0;
    }

    .livetv-category-name {
        font-size: 0.9375rem;
        font-weight: 600;
        color: white;
        margin: 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .livetv-category-count {
        font-size: 0.75rem;
        color: #808080;
        display: block;
        margin-top: 0.25rem;
    }

    .livetv-category-arrow {
        flex-shrink: 0;
        width: 20px;
        height: 20px;
        color: #606060;
        opacity: 0;
        transform: translateX(-8px);
        transition: all 0.3s;
    }

    .livetv-category-card:hover .livetv-category-arrow {
        opacity: 1;
        transform: translateX(0);
        color: #E50914;
    }

    .livetv-category-arrow svg {
        width: 100%;
        height: 100%;
    }

    /* =====================================================
       LIVE TV - CHANNEL GRID STYLES
       ===================================================== */

    .livetv-channels-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 1.25rem;
    }

    @media (min-width: 1400px) {
        .livetv-channels-grid {
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        }
    }

    /* Channel Card */
    .livetv-channel-card {
        position: relative;
        background: linear-gradient(180deg, #1e1e1e 0%, #141414 100%);
        border: 1px solid rgba(255,255,255,0.06);
        border-radius: 16px;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .livetv-channel-card:hover {
        transform: translateY(-6px) scale(1.02);
        border-color: rgba(229, 9, 20, 0.4);
        box-shadow: 0 20px 50px rgba(0,0,0,0.5), 0 0 0 1px rgba(229, 9, 20, 0.15);
    }

    /* Live Badge */
    .livetv-live-badge {
        position: absolute;
        top: 12px;
        left: 12px;
        z-index: 5;
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        background: rgba(229, 9, 20, 0.95);
        border-radius: 4px;
        font-size: 0.625rem;
        font-weight: 700;
        color: white;
        letter-spacing: 0.05em;
        text-transform: uppercase;
    }

    .livetv-live-dot {
        width: 6px;
        height: 6px;
        background: white;
        border-radius: 50%;
        animation: pulse-live 1.5s ease-in-out infinite;
    }

    @keyframes pulse-live {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.5; transform: scale(0.8); }
    }

    /* Channel Logo */
    .livetv-channel-logo {
        position: relative;
        height: 140px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(180deg, rgba(255,255,255,0.02) 0%, rgba(255,255,255,0) 100%);
        padding: 1.5rem;
    }

    .livetv-channel-logo img {
        max-width: 100px;
        max-height: 80px;
        width: auto;
        height: auto;
        object-fit: contain;
        filter: drop-shadow(0 4px 12px rgba(0,0,0,0.3));
        transition: transform 0.3s;
    }

    .livetv-channel-card:hover .livetv-channel-logo img {
        transform: scale(1.1);
    }

    /* Channel Info */
    .livetv-channel-info {
        padding: 1rem 1.25rem 1.25rem;
        border-top: 1px solid rgba(255,255,255,0.04);
    }

    .livetv-channel-name {
        font-size: 1rem;
        font-weight: 600;
        color: white;
        margin: 0 0 0.5rem 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .livetv-channel-epg {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.8125rem;
        margin-bottom: 0.75rem;
    }

    .livetv-now-label {
        color: #E50914;
        font-weight: 600;
        flex-shrink: 0;
    }

    .livetv-now-title {
        color: #a0a0a0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* EPG Progress Bar */
    .livetv-epg-progress {
        height: 3px;
        background: rgba(255,255,255,0.08);
        border-radius: 2px;
        overflow: hidden;
    }

    .livetv-epg-progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #E50914 0%, #ff6b6b 100%);
        border-radius: 2px;
        transition: width 0.5s ease;
    }

    /* Hover Actions */
    .livetv-channel-actions {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(4px);
        opacity: 0;
        visibility: hidden;
        transition: all 0.25s ease;
    }

    .livetv-channel-card:hover .livetv-channel-actions {
        opacity: 1;
        visibility: visible;
    }

    .livetv-action-btn {
        width: 52px;
        height: 52px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.2s;
        color: white;
    }

    .livetv-action-btn svg {
        width: 24px;
        height: 24px;
    }

    .livetv-preview-btn {
        background: rgba(255,255,255,0.1);
        border: 1px solid rgba(255,255,255,0.2);
    }

    .livetv-preview-btn:hover {
        background: rgba(255,255,255,0.2);
        transform: scale(1.1);
    }

    .livetv-play-btn {
        background: #E50914;
        width: 64px;
        height: 64px;
    }

    .livetv-play-btn:hover {
        background: #ff1a27;
        transform: scale(1.15);
        box-shadow: 0 0 30px rgba(229, 9, 20, 0.5);
    }

    .livetv-play-btn svg {
        width: 28px;
        height: 28px;
        margin-left: 2px;
    }

    .livetv-record-btn {
        background: rgba(255,255,255,0.1);
        border: 1px solid rgba(255,255,255,0.2);
    }

    .livetv-record-btn:hover {
        background: rgba(220, 38, 38, 0.9);
        border-color: #dc2626;
        transform: scale(1.1);
    }

    .livetv-record-btn svg {
        width: 20px;
        height: 20px;
        color: #dc2626;
    }

    .livetv-record-btn:hover svg {
        color: white;
    }

    /* =====================================================
       RESPONSIVE ADJUSTMENTS
       ===================================================== */

    @media (max-width: 768px) {
        .livetv-category-card {
            width: 180px;
        }

        .livetv-channels-grid {
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 1rem;
        }

        .livetv-channel-logo {
            height: 120px;
        }

        .livetv-country-flag {
            font-size: 1.5rem;
        }

        .livetv-country-title h2 {
            font-size: 1.25rem;
        }

        .livetv-scroll-btn {
            display: none;
        }
    }
</style>
` }) %>
